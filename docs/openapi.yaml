openapi: "3.0.4"
info:
  title: File Sharing System API
  description: |
    H·ªá th·ªëng chia s·∫ª file t·∫°m th·ªùi v·ªõi c√°c t√≠nh nƒÉng:
    - Upload file v√† t·∫°o link chia s·∫ª
    - Thi·∫øt l·∫≠p quy·ªÅn truy c·∫≠p (public/password-protected/private)
    - Th·ªùi gian hi·ªáu l·ª±c linh ho·∫°t (from/to)
    - B·∫£o v·ªá b·∫±ng m·∫≠t kh·∫©u ho·∫∑c TOTP
    - Chia s·∫ª v·ªõi danh s√°ch ng∆∞·ªùi d√πng c·ª• th·ªÉ
    - T·ª± ƒë·ªông x√≥a file h·∫øt h·∫°n
    - Password reset qua email
    
    ---
    
    ## üìß Email Templates
    
    ### Password Reset Email Template
    
    **Subject:** Reset Your Password - File Sharing System
    
    **Body:**
    ```
    Hi {{username}},
    
    We received a request to reset your password for your File Sharing System account.
    
    Click the link below to reset your password:
    {{resetLink}}
    
    This link will expire in 30 minutes for security reasons.
    
    If you didn't request a password reset, please ignore this email. 
    Your password will remain unchanged.
    
    For security, never share this link with anyone.
    
    Best regards,
    File Sharing System Team
    ```
    
    **Variables:**
    - `{{username}}`: User's username
    - `{{resetLink}}`: Full reset URL with token (e.g., `https://yourdomain.com/reset-password?token={token}`)
    - `{{expiryMinutes}}`: Token expiry time (default: 30 minutes)
    
    
    ---
    
    ## üîí Security Best Practices
    
    ### Password Reset Token
    - **Token generation:** Use `crypto.randomBytes(32).toString('hex')` ho·∫∑c UUID v4
    - **Token length:** T·ªëi thi·ªÉu 32 characters (64 hex chars recommended)
    - **Expiry time:** 15-30 minutes (recommended: 30 minutes)
    - **One-time use:** Token ph·∫£i invalidate sau khi d√πng
    - **Rate limiting:** Gi·ªõi h·∫°n s·ªë l·∫ßn request reset (e.g., 3 l·∫ßn/gi·ªù per email)
    
    ### Database Cleanup
    - T·ª± ƒë·ªông x√≥a expired tokens (cron job ch·∫°y m·ªói gi·ªù ho·∫∑c khi c√≥ request m·ªõi)
    - X√≥a used tokens sau 24h (optional, ƒë·ªÉ audit n·∫øu c·∫ßn)
    
    ### Email Sending (Simple Setup cho ƒê·ªì √Ån)
    - **Development/Demo:** D√πng **Nodemailer** v·ªõi Gmail SMTP
      ```javascript
      // Example: nodemailer config
      const transporter = nodemailer.createTransport({
        service: 'gmail',
        auth: {
          user: 'your-email@gmail.com',
          pass: 'app-specific-password'  // T·∫°o trong Google Account Settings
        }
      });
      ```
    - **Alternative:** Mailtrap.io (free tier, test email kh√¥ng g·ª≠i th·∫≠t)
    - **Rate limit:** Kh√¥ng b·∫Øt bu·ªôc cho ƒë·ªì √°n, nh∆∞ng n√™n c√≥ c∆° b·∫£n (e.g., 5 emails/gi·ªù)
    - **Logging:** Console.log ƒë∆°n gi·∫£n l√† ƒë·ªß (optional: l∆∞u v√†o database)
  version: 1.0.0
  contact:
    name: API Support
    email: support@filesharing.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080/api
    description: Development server
  - url: https://api.filesharing.com/api
    description: Production server

tags:
  - name: Authentication
    description: User authentication and authorization
  - name: Files
    description: File management operations
  - name: Admin
    description: Admin-only operations

security:
  - BearerAuth: []

paths:
  /auth/register:
    post:
      tags:
        - Authentication
      summary: ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi
      description: |
        T·∫°o t√†i kho·∫£n ng∆∞·ªùi d√πng m·ªõi (kh√¥ng b·∫Øt bu·ªôc ƒë·ªÉ upload file).
        
        **L∆∞u √Ω:**
        - User t·ª± ƒëƒÉng k√Ω s·∫Ω lu√¥n c√≥ `role = user` (m·∫∑c ƒë·ªãnh)
        - Admin account ƒë∆∞·ª£c t·∫°o qua script/seed data ho·∫∑c endpoint ri√™ng (ch·ªâ admin g·ªçi ƒë∆∞·ª£c)
        
        **L∆∞u √Ω v·ªÅ TOTP/2FA:**
        - Kh√¥ng th·ªÉ b·∫≠t TOTP ngay khi ƒëƒÉng k√Ω
        - Sau khi ƒëƒÉng k√Ω, user c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ l·∫•y Bearer token
        - Sau ƒë√≥ g·ªçi `/auth/totp/setup` v√† `/auth/totp/verify` ƒë·ªÉ b·∫≠t 2FA
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
            examples:
              basic:
                summary: ƒêƒÉng k√Ω t√†i kho·∫£n c∆° b·∫£n
                value:
                  username: nam123
                  email: nam@example.com
                  password: "123456"
      responses:
        '200':
          description: ƒêƒÉng k√Ω th√†nh c√¥ng
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
              examples:
                success:
                  summary: ƒêƒÉng k√Ω th√†nh c√¥ng
                  value:
                    message: User registered successfully
                    userId: 550e8400-e29b-41d4-a716-446655440000
        '400':
          description: Thi·∫øu ho·∫∑c sai ƒë·ªãnh d·∫°ng tr∆∞·ªùng b·∫Øt bu·ªôc
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingField:
                  summary: Thi·∫øu email
                  value:
                    error: Validation error
                    message: Email is required
                invalidEmail:
                  summary: Email kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng
                  value:
                    error: Validation error
                    message: Email format is invalid
        '409':
          description: Email ho·∫∑c username ƒë√£ t·ªìn t·∫°i
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                emailExists:
                  summary: Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng
                  value:
                    error: Conflict
                    message: Email already exists
                usernameExists:
                  summary: Username ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng
                  value:
                    error: Conflict
                    message: Username already exists

  /auth/login:
    post:
      tags:
        - Authentication
      summary: ƒêƒÉng nh·∫≠p
      description: |
        ƒêƒÉng nh·∫≠p ƒë·ªÉ l·∫•y JWT token.
        
        **Lu·ªìng x·ª≠ l√Ω:**
        1. N·∫øu user ch∆∞a b·∫≠t TOTP: tr·∫£ v·ªÅ accessToken ngay
        2. N·∫øu user ƒë√£ b·∫≠t TOTP (totpEnabled=true): tr·∫£ v·ªÅ `requireTOTP: true`, client c·∫ßn g·ªçi `/auth/login/totp` ƒë·ªÉ ho√†n t·∫•t ƒëƒÉng nh·∫≠p
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: ƒêƒÉng nh·∫≠p th√†nh c√¥ng ho·∫∑c y√™u c·∫ßu TOTP
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/LoginResponse'
                  - $ref: '#/components/schemas/TOTPRequiredResponse'
              examples:
                success:
                  summary: ƒêƒÉng nh·∫≠p th√†nh c√¥ng (kh√¥ng c√≥ TOTP)
                  value:
                    accessToken: eyJhbGciOi...
                    user:
                      id: 550e8400-e29b-41d4-a716-446655440000
                      username: nam123
                      email: nam@example.com
                totpRequired:
                  summary: Y√™u c·∫ßu TOTP (user ƒë√£ b·∫≠t 2FA)
                  value:
                    requireTOTP: true
                    message: TOTP verification required
        '401':
          description: Sai email ho·∫∑c password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidCredential:
                  summary: Sai email ho·∫∑c password
                  value:
                    error: Unauthorized
                    message: Invalid email or password

  /auth/login/totp:
    post:
      tags:
        - Authentication
      summary: X√°c th·ª±c TOTP ƒë·ªÉ ho√†n t·∫•t ƒëƒÉng nh·∫≠p
      description: |
        G·ªçi endpoint n√†y sau khi `/auth/login` tr·∫£ v·ªÅ `requireTOTP: true`.
        X√°c th·ª±c m√£ TOTP 6 ch·ªØ s·ªë ƒë·ªÉ l·∫•y access token.
        
        **Kh√¥ng c·∫ßn Bearer token** v√¨ ƒë√¢y l√† b∆∞·ªõc ho√†n t·∫•t ƒëƒÉng nh·∫≠p - user ch∆∞a c√≥ token.
        Backend x√°c minh m√£ TOTP ƒë√∫ng th√¨ m·ªõi c·∫•p access token l·∫ßn ƒë·∫ßu.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TOTPVerifyRequest'
            examples:
              login:
                summary: X√°c th·ª±c TOTP khi ƒëƒÉng nh·∫≠p
                value:
                  email: nam@example.com
                  code: "123456"
      responses:
        '200':
          description: X√°c th·ª±c th√†nh c√¥ng
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: M√£ TOTP kh√¥ng h·ª£p l·ªá ho·∫∑c phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidTotp:
                  summary: Sai m√£ TOTP
                  value:
                    error: Unauthorized
                    message: Invalid or expired TOTP code
                loginExpired:
                  summary: Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n
                  value:
                    error: Unauthorized
                    message: Login session expired. Please restart the login flow.

  /auth/totp/setup:
    post:
      tags:
        - Authentication
      summary: Thi·∫øt l·∫≠p TOTP
      description: |
        B·∫≠t ho·∫∑c reset TOTP (2FA) cho user.
        
        **Y√™u c·∫ßu:** User ph·∫£i ƒëƒÉng nh·∫≠p tr∆∞·ªõc (c·∫ßn Bearer token).
        
        **Lu·ªìng s·ª≠ d·ª•ng:**
        1. User ƒëƒÉng nh·∫≠p b√¨nh th∆∞·ªùng ƒë·ªÉ l·∫•y Bearer token
        2. G·ªçi endpoint n√†y ƒë·ªÉ nh·∫≠n TOTP secret v√† QR code
        3. Qu√©t QR code b·∫±ng app authenticator (Google Authenticator, Authy,...)
        4. G·ªçi `/auth/totp/verify` v·ªõi m√£ 6 s·ªë ƒë·ªÉ k√≠ch ho·∫°t 2FA
      security:
        - BearerAuth: []
      responses:
        '200':
          description: TOTP secret ƒë∆∞·ª£c t·∫°o
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TOTPSetupResponse'
              examples:
                success:
                  summary: TOTP setup th√†nh c√¥ng
                  value:
                    message: TOTP secret generated
                    totpSetup:
                      secret: NB2W45DFOIZA====
                      qrCode: data:image/png;base64,iVBORw0KGgo...
        '401':
          description: Thi·∫øu ho·∫∑c sai Bearer token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingToken:
                  summary: Thi·∫øu Authorization header
                  value:
                    error: Unauthorized
                    message: Bearer token is required
                invalidToken:
                  summary: Token kh√¥ng h·ª£p l·ªá
                  value:
                    error: Unauthorized
                    message: Invalid or expired access token

  /auth/totp/verify:
    post:
      tags:
        - Authentication
      summary: X√°c minh m√£ TOTP ƒë·ªÉ k√≠ch ho·∫°t 2FA
      description: |
        X√°c minh m√£ TOTP 6 ch·ªØ s·ªë ƒë·ªÉ k√≠ch ho·∫°t 2FA cho t√†i kho·∫£n.
        
        **Y√™u c·∫ßu:** User ph·∫£i ƒëƒÉng nh·∫≠p v√† ƒë√£ g·ªçi `/auth/totp/setup` tr∆∞·ªõc ƒë√≥ (c·∫ßn Bearer token).
        
        **Sau khi verify th√†nh c√¥ng:**
        - T√†i kho·∫£n ƒë∆∞·ª£c ƒë√°nh d·∫•u `totpEnabled = true`
        - C√°c l·∫ßn ƒëƒÉng nh·∫≠p sau s·∫Ω y√™u c·∫ßu m√£ TOTP
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                code:
                  type: string
                  pattern: '^\d{6}$'
                  description: M√£ TOTP 6 ch·ªØ s·ªë t·ª´ app authenticator
                  example: "123456"
              required:
                - code
      responses:
        '200':
          description: TOTP ƒë∆∞·ª£c x√°c minh th√†nh c√¥ng, 2FA ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: TOTP verified successfully
                  totpEnabled:
                    type: boolean
                    example: true
        '400':
          description: M√£ TOTP kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidCode:
                  summary: M√£ kh√¥ng ƒë√∫ng
                  value:
                    error: Invalid TOTP code
                    message: The provided code is incorrect or expired
        '401':
          description: Thi·∫øu ho·∫∑c sai Bearer token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingToken:
                  summary: Thi·∫øu Authorization header
                  value:
                    error: Unauthorized
                    message: Bearer token is required
                invalidToken:
                  summary: Token kh√¥ng h·ª£p l·ªá
                  value:
                    error: Unauthorized
                    message: Invalid or expired access token

  /auth/totp/disable:
    post:
      tags:
        - Authentication
      summary: T·∫Øt TOTP/2FA
      description: |
        T·∫Øt TOTP (2FA) cho t√†i kho·∫£n.
        
        **Y√™u c·∫ßu:** 
        - User ph·∫£i ƒëƒÉng nh·∫≠p (c·∫ßn Bearer token)
        - User ph·∫£i c√≥ TOTP ƒë√£ b·∫≠t (`totpEnabled = true`)
        - Ph·∫£i x√°c minh m√£ TOTP hi·ªán t·∫°i ƒë·ªÉ x√°c nh·∫≠n l√† ch·ªß t√†i kho·∫£n
        
        **Lu·ªìng x·ª≠ l√Ω:**
        1. User g·ªçi endpoint n√†y v·ªõi Bearer token
        2. Nh·∫≠p m√£ TOTP 6 s·ªë t·ª´ Google Authenticator
        3. Backend verify m√£ TOTP ƒë√∫ng ‚Üí t·∫Øt 2FA (`totpEnabled = false`, x√≥a `totpSecret`)
        
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                code:
                  type: string
                  pattern: '^\d{6}$'
                  description: M√£ TOTP 6 ch·ªØ s·ªë t·ª´ app authenticator
                  example: "123456"
              required:
                - code
      responses:
        '200':
          description: TOTP ƒë√£ ƒë∆∞·ª£c t·∫Øt th√†nh c√¥ng
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: TOTP disabled successfully
                  totpEnabled:
                    type: boolean
                    example: false
        '400':
          description: M√£ TOTP kh√¥ng h·ª£p l·ªá ho·∫∑c TOTP ch∆∞a ƒë∆∞·ª£c b·∫≠t
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidCode:
                  summary: M√£ TOTP kh√¥ng ƒë√∫ng
                  value:
                    error: Invalid TOTP code
                    message: The provided code is incorrect or expired
                totpNotEnabled:
                  summary: TOTP ch∆∞a ƒë∆∞·ª£c b·∫≠t
                  value:
                    error: TOTP not enabled
                    message: TOTP is not enabled for this account
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/password/change:
    post:
      tags:
        - Authentication
      summary: ƒê·ªïi m·∫≠t kh·∫©u
      description: |
        ƒê·ªïi m·∫≠t kh·∫©u cho user ƒë√£ ƒëƒÉng nh·∫≠p.
        
        **Y√™u c·∫ßu:** User ph·∫£i ƒëƒÉng nh·∫≠p (c·∫ßn Bearer token)
        
        **Hai c√°ch x√°c th·ª±c:**
        1. **C√≥ password c≈©:** Nh·∫≠p `oldPassword` + `newPassword`
        2. **Qu√™n password c≈© nh∆∞ng c√≥ TOTP:** Nh·∫≠p `totpCode` + `newPassword` (ch·ªâ cho account ƒë√£ b·∫≠t 2FA)
        
        **Validation:**
        - `newPassword` ph·∫£i >= 6 k√Ω t·ª± (theo system policy)
        - `newPassword` ph·∫£i kh√°c `oldPassword`
        - Ph·∫£i c√≥ √≠t nh·∫•t m·ªôt trong hai: `oldPassword` ho·∫∑c `totpCode`
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                oldPassword:
                  type: string
                  format: password
                  description: M·∫≠t kh·∫©u hi·ªán t·∫°i (b·∫Øt bu·ªôc n·∫øu kh√¥ng c√≥ totpCode)
                  example: "oldpass123"
                totpCode:
                  type: string
                  pattern: '^\d{6}$'
                  description: M√£ TOTP 6 ch·ªØ s·ªë (b·∫Øt bu·ªôc n·∫øu kh√¥ng c√≥ oldPassword, ch·ªâ d√πng khi account ƒë√£ b·∫≠t 2FA)
                  example: "123456"
                newPassword:
                  type: string
                  format: password
                  minLength: 6
                  description: M·∫≠t kh·∫©u m·ªõi (t·ªëi thi·ªÉu 6 k√Ω t·ª±)
                  example: "newpass456"
              required:
                - newPassword
            examples:
              withOldPassword:
                summary: ƒê·ªïi password b·∫±ng password c≈©
                value:
                  oldPassword: "oldpass123"
                  newPassword: "newpass456"
              withTOTP:
                summary: ƒê·ªïi password b·∫±ng TOTP (qu√™n password c≈©)
                value:
                  totpCode: "123456"
                  newPassword: "newpass456"
      responses:
        '200':
          description: ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password changed successfully
        '400':
          description: Validation error ho·∫∑c thi·∫øu th√¥ng tin x√°c th·ª±c
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingAuth:
                  summary: Thi·∫øu oldPassword v√† totpCode
                  value:
                    error: Validation error
                    message: Either oldPassword or totpCode is required
                invalidOldPassword:
                  summary: Sai password c≈©
                  value:
                    error: Invalid password
                    message: The old password is incorrect
                invalidTOTP:
                  summary: Sai m√£ TOTP
                  value:
                    error: Invalid TOTP code
                    message: The provided TOTP code is incorrect or expired
                totpNotEnabled:
                  summary: Account kh√¥ng c√≥ TOTP nh∆∞ng g·ª≠i totpCode
                  value:
                    error: TOTP not enabled
                    message: This account does not have TOTP enabled. Please use oldPassword instead
                weakPassword:
                  summary: Password m·ªõi qu√° y·∫øu
                  value:
                    error: Validation error
                    message: New password must be at least 6 characters
                samePassword:
                  summary: Password m·ªõi tr√πng password c≈©
                  value:
                    error: Validation error
                    message: New password must be different from the old password
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/password/forgot:
    post:
      tags:
        - Authentication
      summary: Y√™u c·∫ßu reset m·∫≠t kh·∫©u
      description: |
        G·ª≠i y√™u c·∫ßu reset m·∫≠t kh·∫©u khi user qu√™n password.
        
        
        1. **User nh·∫≠p email** ‚Üí g·ªçi endpoint n√†y
        2. **Backend x·ª≠ l√Ω:**
           - Ki·ªÉm tra email c√≥ t·ªìn t·∫°i kh√¥ng
           - **N·∫øu account c√≥ TOTP enabled:** tr·∫£ v·ªÅ `requireTOTP: true` ‚Üí user ph·∫£i d√πng TOTP ƒë·ªÉ reset
           - **N·∫øu account kh√¥ng c√≥ TOTP:**
             - T·∫°o reset token (random, secure, one-time use)
             - L∆∞u v√†o database v·ªõi expiry time (th∆∞·ªùng 15-30 ph√∫t)
             - G·ª≠i email ch·ª©a reset link: `https://yourdomain.com/reset-password?token={resetToken}`
        3. **User click link trong email** ‚Üí Frontend navigate ƒë·∫øn page reset password v·ªõi token trong URL
        4. **User nh·∫≠p password m·ªõi** ‚Üí g·ªçi `/auth/password/reset` v·ªõi token + newPassword
        
        **Security Best Practices:**
        - Token ph·∫£i random, unpredictable (s·ª≠ d·ª•ng crypto.randomBytes ho·∫∑c uuid)
        - Token ch·ªâ d√πng ƒë∆∞·ª£c 1 l·∫ßn (one-time use)
        - Token c√≥ expiry time (15-30 ph√∫t)
        - Endpoint lu√¥n tr·∫£ 200 OK (ngay c·∫£ khi email kh√¥ng t·ªìn t·∫°i) ƒë·ªÉ tr√°nh enumerate users
        - Email ph·∫£i ch·ª©a warning: "N·∫øu b·∫°n kh√¥ng y√™u c·∫ßu reset password, h√£y b·ªè qua email n√†y"

      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                  description: Email c·ªßa t√†i kho·∫£n c·∫ßn reset password
                  example: nam@example.com
              required:
                - email
      responses:
        '200':
          description: Y√™u c·∫ßu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      message:
                        type: string
                        example: If the email exists, you will receive a password reset link
                  - type: object
                    properties:
                      requireTOTP:
                        type: boolean
                        example: true
                      message:
                        type: string
                        example: This account has TOTP enabled. Please provide the TOTP code to reset password
              examples:
                noTOTP:
                  summary: Account kh√¥ng c√≥ TOTP (g·ª≠i email reset)
                  value:
                    message: If the email exists, you will receive a password reset link
                withTOTP:
                  summary: Account c√≥ TOTP (y√™u c·∫ßu m√£ TOTP)
                  value:
                    requireTOTP: true
                    message: This account has TOTP enabled. Please provide the TOTP code to reset password
        '400':
          description: Email kh√¥ng h·ª£p l·ªá
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidEmail:
                  summary: Email kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng
                  value:
                    error: Validation error
                    message: Invalid email format

  /auth/password/reset:
    post:
      tags:
        - Authentication
      summary: Reset m·∫≠t kh·∫©u
      description: |
        Reset m·∫≠t kh·∫©u sau khi g·ªçi `/auth/password/forgot`.
        
        **Hai lu·ªìng x·ª≠ l√Ω:**
        
        ### Account c√≥ TOTP enabled (2FA):
        - User g·ªçi `/auth/password/forgot` ‚Üí nh·∫≠n `requireTOTP: true`
        - User g·ªçi endpoint n√†y v·ªõi: `email` + `totpCode` + `newPassword`
        - Backend verify m√£ TOTP ‚Üí reset password
        
        ### Account kh√¥ng c√≥ TOTP (standard flow):
        - User g·ªçi `/auth/password/forgot` ‚Üí nh·∫≠n email ch·ª©a reset link
        - User click link ‚Üí Frontend g·ªçi endpoint n√†y v·ªõi: `resetToken` + `newPassword`
        - Backend ki·ªÉm tra token (valid, ch∆∞a d√πng, ch∆∞a h·∫øt h·∫°n) ‚Üí reset password ‚Üí ƒë√°nh d·∫•u token ƒë√£ d√πng
        
        **Security Notes:**
        - Reset token ch·ªâ d√πng ƒë∆∞·ª£c 1 l·∫ßn (one-time use)
        - Sau khi reset th√†nh c√¥ng, token b·ªã invalidate ngay
        - Token c√≥ expiry time (15-30 ph√∫t)
        - Kh√¥ng ƒë∆∞·ª£c reuse token ƒë√£ d√πng
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                  description: Email t√†i kho·∫£n (b·∫Øt bu·ªôc khi d√πng TOTP)
                  example: nam@example.com
                totpCode:
                  type: string
                  pattern: '^\d{6}$'
                  description: M√£ TOTP 6 ch·ªØ s·ªë (cho account c√≥ 2FA)
                  example: "123456"
                resetToken:
                  type: string
                  description: Token t·ª´ email reset link (cho account kh√¥ng c√≥ TOTP)
                  example: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
                newPassword:
                  type: string
                  format: password
                  minLength: 6
                  description: M·∫≠t kh·∫©u m·ªõi (t·ªëi thi·ªÉu 6 k√Ω t·ª±)
                  example: "newpass789"
              required:
                - newPassword
            examples:
              withTOTP:
                summary: Reset password b·∫±ng TOTP (account c√≥ 2FA)
                value:
                  email: nam@example.com
                  totpCode: "123456"
                  newPassword: "newpass789"
              withResetToken:
                summary: Reset password b·∫±ng token t·ª´ email
                value:
                  resetToken: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
                  newPassword: "newpass789"
      responses:
        '200':
          description: Reset password th√†nh c√¥ng
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password reset successfully. You can now login with your new password
              examples:
                success:
                  summary: Password ƒë√£ ƒë∆∞·ª£c reset
                  value:
                    message: Password reset successfully. You can now login with your new password
        '400':
          description: Validation error ho·∫∑c token kh√¥ng h·ª£p l·ªá
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidTOTP:
                  summary: Sai m√£ TOTP
                  value:
                    error: Invalid TOTP code
                    message: The provided TOTP code is incorrect or expired
                invalidResetToken:
                  summary: Token reset kh√¥ng h·ª£p l·ªá
                  value:
                    error: Invalid reset token
                    message: The reset token is invalid or does not exist
                expiredToken:
                  summary: Token ƒë√£ h·∫øt h·∫°n
                  value:
                    error: Reset token expired
                    message: This reset link has expired. Please request a new one
                usedToken:
                  summary: Token ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng
                  value:
                    error: Reset token already used
                    message: This reset link has already been used. Please request a new one if needed
                missingAuth:
                  summary: Thi·∫øu totpCode ho·∫∑c resetToken
                  value:
                    error: Validation error
                    message: Either totpCode (with email) or resetToken is required
                weakPassword:
                  summary: Password m·ªõi qu√° y·∫øu
                  value:
                    error: Validation error
                    message: New password must be at least 6 characters
        '404':
          description: Email kh√¥ng t·ªìn t·∫°i (ch·ªâ cho flow TOTP)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                notFound:
                  summary: Email kh√¥ng t·ªìn t·∫°i
                  value:
                    error: Not found
                    message: Email not found

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: ƒêƒÉng xu·∫•t
      description: ƒêƒÉng xu·∫•t (client t·ª± x√≥a token)
      responses:
        '200':
          description: ƒêƒÉng xu·∫•t th√†nh c√¥ng
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User logged out

  /user:
    get:
      tags:
        - Authentication
      summary: L·∫•y th√¥ng tin user v√† danh s√°ch file
      description: |
        L·∫•y th√¥ng tin profile c·ªßa user hi·ªán t·∫°i (ƒë√£ ƒëƒÉng nh·∫≠p) v√† danh s√°ch t·∫•t c·∫£ file ƒë√£ upload.
        
        **Bao g·ªìm:**
        - Th√¥ng tin user: id, username, email, role, totpEnabled
        - Danh s√°ch file: active, expired, pending, deleted
        - Pagination v√† summary statistics
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          description: L·ªçc theo tr·∫°ng th√°i file
          schema:
            type: string
            enum: [active, expired, pending, deleted, all]
            default: all
        - name: page
          in: query
          description: S·ªë trang
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: limit
          in: query
          description: S·ªë file m·ªói trang
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: sortBy
          in: query
          description: S·∫Øp x·∫øp theo
          schema:
            type: string
            enum: [createdAt, fileName]
            default: createdAt
        - name: order
          in: query
          description: Th·ª© t·ª± s·∫Øp x·∫øp
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Th√¥ng tin user v√† danh s√°ch file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfileResponse'
              examples:
                success:
                  summary: Th√¥ng tin user v√† file
                  value:
                    user:
                      id: 550e8400-e29b-41d4-a716-446655440000
                      username: nam123
                      email: nam@example.com
                      role: user
                      totpEnabled: true
                    files:
                      - id: 550e8400-e29b-41d4-a716-446655440001
                        fileName: document.pdf
                        status: active
                        createdAt: "2025-11-19T10:00:00Z"
                      - id: 550e8400-e29b-41d4-a716-446655440002
                        fileName: old-file.pdf
                        status: expired
                        createdAt: "2025-11-10T10:00:00Z"
                    pagination:
                      currentPage: 1
                      totalPages: 3
                      totalFiles: 42
                      limit: 20
                    summary:
                      activeFiles: 28
                      pendingFiles: 5
                      expiredFiles: 9
                      deletedFiles: 0
        '401':
          $ref: '#/components/responses/Unauthorized'

  /files/upload:
    post:
      tags:
        - Files
      summary: Upload file
      description: |
        Upload file m·ªõi v√† t·∫°o share link.
        Authorization header l√† optional - n·∫øu kh√¥ng c√≥ th√¨ anonymous upload.
      security:
        - BearerAuth: []
        - {}
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/FileUploadRequest'
      responses:
        '201':
          description: Upload th√†nh c√¥ng
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileUploadResponse'
              examples:
                success:
                  summary: Upload th√†nh c√¥ng
                  value:
                    success: true
                    message: File uploaded successfully
                    file:
                      id: 550e8400-e29b-41d4-a716-446655440000
                      fileName: report.pdf
                      shareToken: a1b2c3d4e5f6g7h8
                    totpSetup:
                      secret: NB2W45DFOIZA====
                      qrCode: data:image/png;base64,iVBORw0KGgo...
        '400':
          description: Thi·∫øu file ho·∫∑c vi ph·∫°m validation (password qu√° ng·∫Øn, availableTo < availableFrom, ... )
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingFile:
                  summary: Kh√¥ng g·ª≠i file trong form-data
                  value:
                    error: Validation error
                    message: File is required
                weakPassword:
                  summary: Password < 6 k√Ω t·ª±
                  value:
                    error: Validation error
                    message: Password must have at least 6 characters
        '401':
          description: Thi·∫øu ho·∫∑c sai Bearer token (khi upload v·ªõi quy·ªÅn ri√™ng t∆∞)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingToken:
                  summary: Thi·∫øu Authorization header
                  value:
                    error: Unauthorized
                    message: Bearer token is required for authenticated uploads
        '413':
          description: File qu√° l·ªõn
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                fileTooLarge:
                  summary: File v∆∞·ª£t qu√° gi·ªõi h·∫°n
                  value:
                    error: Payload too large
                    message: File size exceeds the system limit

  /files/{id}:
    get:
      tags:
        - Files
      summary: L·∫•y th√¥ng tin file theo ID
      description: |
        L·∫•y th√¥ng tin chi ti·∫øt c·ªßa file theo UUID (ch·ªâ owner ho·∫∑c admin).
        
        **Kh√°c v·ªõi `/files/{shareToken}`:**
        - Endpoint n√†y d√πng UUID (file ID), y√™u c·∫ßu authentication
        - Ch·ªâ owner ho·∫∑c admin m·ªõi truy c·∫≠p ƒë∆∞·ª£c
        - Tr·∫£ v·ªÅ ƒë·∫ßy ƒë·ªß metadata bao g·ªìm c·∫£ th√¥ng tin nh·∫°y c·∫£m (kh√¥ng public)
        
        **Use case:** Owner xem th√¥ng tin file c·ªßa m√¨nh trong dashboard
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: File UUID
          schema:
            type: string
            format: uuid
            example: 550e8400-e29b-41d4-a716-446655440000
      responses:
        '200':
          description: Th√¥ng tin file chi ti·∫øt
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileInfoResponse'
              examples:
                success:
                  summary: File metadata ƒë·∫ßy ƒë·ªß
                  value:
                    file:
                      id: 550e8400-e29b-41d4-a716-446655440000
                      fileName: contract.pdf
                      fileSize: 2048576
                      mimeType: application/pdf
                      shareToken: a1b2c3d4e5f6g7h8
                      shareLink: https://example.com/f/a1b2c3d4e5f6g7h8
                      isPublic: false
                      hasPassword: true
                      totpEnabled: true
                      availableFrom: "2025-11-10T00:00:00Z"
                      availableTo: "2025-11-17T00:00:00Z"
                      status: active
                      hoursRemaining: 120.5
                      sharedWith: ["user1@example.com", "user2@example.com"]
                      owner:
                        id: 550e8400-e29b-41d4-a716-446655440001
                        username: nam123
                        email: nam@example.com
                        role: user
                      createdAt: "2025-11-10T10:00:00Z"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Kh√¥ng ph·∫£i owner ho·∫∑c admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                notOwner:
                  summary: User kh√¥ng c√≥ quy·ªÅn truy c·∫≠p file n√†y
                  value:
                    error: Forbidden
                    message: You don't have permission to access this file
        '404':
          description: Kh√¥ng t√¨m th·∫•y file v·ªõi ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                notFound:
                  summary: File kh√¥ng t·ªìn t·∫°i
                  value:
                    error: Not found
                    message: File not found
    
    delete:
      tags:
        - Files
      summary: X√≥a file
      description: |
        X√≥a file (ch·ªâ owner).
        Anonymous upload KH√îNG TH·ªÇ x√≥a file sau khi upload.
      parameters:
        - name: id
          in: path
          required: true
          description: File UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: X√≥a th√†nh c√¥ng
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  fileId:
                    type: string
                    format: uuid
              examples:
                success:
                  summary: X√≥a th√†nh c√¥ng
                  value:
                    message: File deleted successfully
                    fileId: 550e8400-e29b-41d4-a716-446655440000
        '403':
          description: Kh√¥ng ph·∫£i owner ho·∫∑c anonymous upload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Kh√¥ng t√¨m th·∫•y file v·ªõi id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                notFound:
                  summary: File kh√¥ng t·ªìn t·∫°i
                  value:
                    error: Not found
                    message: File not found

  /files/{id}/stats:
    get:
      tags:
        - Files
      summary: L·∫•y th·ªëng k√™ download c·ªßa file
      description: |
        L·∫•y statistics c·ªßa file t·ª´ b·∫£ng `file_statistics`.
        
        **Y√™u c·∫ßu:** Ch·ªâ owner ho·∫∑c admin m·ªõi xem ƒë∆∞·ª£c
        
        **D·ªØ li·ªáu tr·∫£ v·ªÅ:**
        - `downloadCount`: T·ªïng s·ªë l∆∞·ª£t download
        - `uniqueDownloaders`: S·ªë ng∆∞·ªùi download kh√°c nhau (authenticated users)
        - `lastDownloadedAt`: L·∫ßn download g·∫ßn nh·∫•t
        
        **L∆∞u √Ω:** Anonymous uploads kh√¥ng c√≥ statistics
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: File UUID
          schema:
            type: string
            format: uuid
            example: 550e8400-e29b-41d4-a716-446655440000
      responses:
        '200':
          description: Statistics c·ªßa file
          content:
            application/json:
              schema:
                type: object
                properties:
                  fileId:
                    type: string
                    format: uuid
                    example: 550e8400-e29b-41d4-a716-446655440000
                  fileName:
                    type: string
                    example: presentation.pdf
                  statistics:
                    type: object
                    properties:
                      downloadCount:
                        type: integer
                        description: T·ªïng s·ªë l∆∞·ª£t download
                        example: 45
                      uniqueDownloaders:
                        type: integer
                        description: S·ªë ng∆∞·ªùi download kh√°c nhau (kh√¥ng t√≠nh anonymous)
                        example: 12
                      lastDownloadedAt:
                        type: string
                        format: date-time
                        description: Th·ªùi ƒëi·ªÉm download g·∫ßn nh·∫•t
                        example: "2025-11-19T14:30:00Z"
                      createdAt:
                        type: string
                        format: date-time
                        example: "2025-11-10T10:00:00Z"
              examples:
                success:
                  summary: Statistics c·ªßa file
                  value:
                    fileId: 550e8400-e29b-41d4-a716-446655440000
                    fileName: presentation.pdf
                    statistics:
                      downloadCount: 45
                      uniqueDownloaders: 12
                      lastDownloadedAt: "2025-11-19T14:30:00Z"
                      createdAt: "2025-11-10T10:00:00Z"
                noDownloads:
                  summary: File ch∆∞a c√≥ download n√†o
                  value:
                    fileId: 550e8400-e29b-41d4-a716-446655440000
                    fileName: document.docx
                    statistics:
                      downloadCount: 0
                      uniqueDownloaders: 0
                      lastDownloadedAt: null
                      createdAt: "2025-11-18T08:00:00Z"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Kh√¥ng ph·∫£i owner ho·∫∑c admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                notOwner:
                  summary: Kh√¥ng c√≥ quy·ªÅn xem statistics
                  value:
                    error: Forbidden
                    message: You don't have permission to view statistics for this file
        '404':
          description: File kh√¥ng t·ªìn t·∫°i ho·∫∑c l√† anonymous upload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                notFound:
                  summary: File kh√¥ng t·ªìn t·∫°i
                  value:
                    error: Not found
                    message: File not found or statistics not available (anonymous upload)

  /files/{id}/download-history:
    get:
      tags:
        - Files
      summary: L·∫•y l·ªãch s·ª≠ download chi ti·∫øt
      description: |
        L·∫•y download history t·ª´ b·∫£ng `download_history` (t∆∞∆°ng t·ª± browser download history).
        
        **Y√™u c·∫ßu:** Ch·ªâ owner ho·∫∑c admin m·ªõi xem ƒë∆∞·ª£c
        
        **Th√¥ng tin m·ªói download:**
        - Ng∆∞·ªùi download (username/email ho·∫∑c "Anonymous")
        - Th·ªùi ƒëi·ªÉm download
        - Tr·∫°ng th√°i (completed/interrupted)
        
        **Pagination:** H·ªó tr·ª£ ph√¢n trang v·ªõi `page` v√† `limit`
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: File UUID
          schema:
            type: string
            format: uuid
            example: 550e8400-e29b-41d4-a716-446655440000
        - name: page
          in: query
          description: S·ªë trang
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: limit
          in: query
          description: S·ªë record m·ªói trang
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: L·ªãch s·ª≠ download
          content:
            application/json:
              schema:
                type: object
                properties:
                  fileId:
                    type: string
                    format: uuid
                  fileName:
                    type: string
                  history:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        downloader:
                          type: object
                          properties:
                            username:
                              type: string
                              nullable: true
                            email:
                              type: string
                              nullable: true
                          description: Null n·∫øu l√† anonymous download
                        downloadedAt:
                          type: string
                          format: date-time
                        downloadCompleted:
                          type: boolean
                          description: false n·∫øu download b·ªã gi√°n ƒëo·∫°n
                  pagination:
                    type: object
                    properties:
                      currentPage:
                        type: integer
                      totalPages:
                        type: integer
                      totalRecords:
                        type: integer
                      limit:
                        type: integer
              examples:
                success:
                  summary: Download history v·ªõi multiple users
                  value:
                    fileId: 550e8400-e29b-41d4-a716-446655440000
                    fileName: presentation.pdf
                    history:
                      - id: 650e8400-e29b-41d4-a716-446655440001
                        downloader:
                          username: tranthib
                          email: tranthib@example.com
                        downloadedAt: "2025-11-19T14:30:00Z"
                        downloadCompleted: true
                      - id: 650e8400-e29b-41d4-a716-446655440002
                        downloader: null
                        downloadedAt: "2025-11-19T10:15:00Z"
                        downloadCompleted: true
                      - id: 650e8400-e29b-41d4-a716-446655440003
                        downloader:
                          username: nguyenvana
                          email: nguyenvana@example.com
                        downloadedAt: "2025-11-18T16:45:00Z"
                        downloadCompleted: false
                    pagination:
                      currentPage: 1
                      totalPages: 1
                      totalRecords: 3
                      limit: 50
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Kh√¥ng ph·∫£i owner ho·∫∑c admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                notOwner:
                  summary: Kh√¥ng c√≥ quy·ªÅn xem history
                  value:
                    error: Forbidden
                    message: You don't have permission to view download history for this file
        '404':
          description: File kh√¥ng t·ªìn t·∫°i
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                notFound:
                  summary: File kh√¥ng t·ªìn t·∫°i
                  value:
                    error: Not found
                    message: File not found

  /files/{shareToken}:
    get:
      tags:
        - Files
      summary: L·∫•y th√¥ng tin file
      description: L·∫•y metadata c·ªßa file qua share token
      security: []
      parameters:
        - $ref: '#/components/parameters/ShareToken'
      responses:
        '200':
          description: Th√¥ng tin file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileInfoResponse'
              examples:
                success:
                  summary: Tr·∫£ v·ªÅ metadata
                  value:
                    file:
                      id: 550e8400-e29b-41d4-a716-446655440000
                      fileName: contract.pdf
                      shareToken: a1b2c3d4e5f6g7h8
                      status: active
                      isPublic: false
        '404':
          description: Kh√¥ng t√¨m th·∫•y file v·ªõi shareToken
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                notFound:
                  summary: Token kh√¥ng t·ªìn t·∫°i
                  value:
                    error: Not found
                    message: File not found
        '410':
          description: File ƒë√£ h·∫øt h·∫°n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                expired:
                  summary: File h·∫øt h·∫°n
                  value:
                    error: File expired
                    message: File expired. You cannot validate TOTP anymore.

  /files/{shareToken}/download:
    get:
      tags:
        - Files
      summary: T·∫£i file v·ªÅ
      description: |
        Download file. File c√≥ th·ªÉ c√≥ nhi·ªÅu l·ªõp b·∫£o m·∫≠t c√πng l√∫c (password + whitelist + TOTP).
        
        **Th·ª© t·ª± ki·ªÉm tra b·∫£o m·∫≠t (theo best practice):**
        1. **File status** - Ki·ªÉm tra file c√≤n hi·ªáu l·ª±c (expired/pending) ‚Üí 410/423
        2. **Whitelist** - N·∫øu file c√≥ `sharedWith` list ‚Üí y√™u c·∫ßu Bearer token, verify user email ‚àà whitelist ‚Üí 403 n·∫øu kh√¥ng c√≥ quy·ªÅn
        3. **Password** - N·∫øu file c√≥ password ‚Üí y√™u c·∫ßu query parameter `password` ‚Üí 403 n·∫øu sai/thi·∫øu
        4. **TOTP** - N·∫øu file c√≥ `totpEnabled=true` ‚Üí y√™u c·∫ßu `downloadToken` t·ª´ `/files/{shareToken}/totp/validate` ‚Üí 400 n·∫øu thi·∫øu/sai/h·∫øt h·∫°n
        
        **Lu·ªìng download v·ªõi TOTP:**
        1. User g·ªçi `/files/{shareToken}/totp/validate` v·ªõi m√£ TOTP t·ª´ owner
        2. Backend tr·∫£ v·ªÅ `downloadToken` t·∫°m th·ªùi (valid 5 ph√∫t)
        3. User g·ªçi endpoint n√†y v·ªõi `downloadToken` trong query parameter
        
        **L∆∞u √Ω:** T·∫•t c·∫£ c√°c l·ªõp b·∫£o m·∫≠t ph·∫£i pass th√¨ m·ªõi ƒë∆∞·ª£c download. B·∫•t k·ª≥ l·ªõp n√†o fail s·∫Ω tr·∫£ error t∆∞∆°ng ·ª©ng.
      security:
        - BearerAuth: []
        - {}
      parameters:
        - $ref: '#/components/parameters/ShareToken'
        - name: password
          in: query
          description: M·∫≠t kh·∫©u b·∫£o v·ªá (n·∫øu file c√≥ password)
          schema:
            type: string
        - name: downloadToken
          in: query
          description: Token t·∫°m th·ªùi t·ª´ TOTP validation (n·∫øu file c√≥ TOTP enabled)
          schema:
            type: string
            example: dt_a1b2c3d4e5f6g7h8
      responses:
        '200':
          description: File binary
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
                example: attachment; filename="document.pdf"
            Content-Length:
              schema:
                type: integer
        '400':
          description: Download token kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu (khi file c√≥ TOTP enabled)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingDownloadToken:
                  summary: Thi·∫øu download token (file c√≥ TOTP)
                  value:
                    error: Download token required
                    message: This file requires TOTP verification. Please call /files/{shareToken}/totp/validate first
                invalidDownloadToken:
                  summary: Download token kh√¥ng h·ª£p l·ªá ho·∫∑c h·∫øt h·∫°n
                  value:
                    error: Invalid download token
                    message: The download token is invalid or expired. Please request a new token
        '401':
          description: Thi·∫øu Bearer token khi file c√≥ whitelist (sharedWith)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingAuth:
                  summary: Thi·∫øu Bearer token (file private)
                  value:
                    error: Unauthorized
                    message: This file requires authentication. Please provide a Bearer token
        '403':
          description: Sai password, thi·∫øu password, ho·∫∑c kh√¥ng c√≥ quy·ªÅn truy c·∫≠p
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                wrongPassword:
                  summary: Sai password
                  value:
                    error: Incorrect password
                    message: The file password is incorrect
                missingPassword:
                  summary: Thi·∫øu password (file c√≥ password)
                  value:
                    error: Password required
                    message: This file is password-protected. Please provide the password parameter
                notWhitelisted:
                  summary: User kh√¥ng n·∫±m trong whitelist
                  value:
                    error: Access denied
                    message: You are not allowed to download this file. Your email is not in the shared list
        '404':
          description: Kh√¥ng t√¨m th·∫•y file ho·∫∑c downloadToken kh√¥ng ƒë√∫ng shareToken
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                notFound:
                  summary: Share token kh√¥ng t·ªìn t·∫°i
                  value:
                    error: Not found
                    message: File not found
        '410':
          description: File ƒë√£ h·∫øt h·∫°n
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  expiredAt:
                    type: string
                    format: date-time
              examples:
                expired:
                  summary: File h·∫øt h·∫°n
                  value:
                    error: File expired
                    expiredAt: "2025-11-19T16:20:18.619Z"
        '423':
          description: File ch∆∞a ƒë·∫øn th·ªùi gian hi·ªáu l·ª±c
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  availableFrom:
                    type: string
                    format: date-time
                  hoursUntilAvailable:
                    type: number
              examples:
                pending:
                  summary: File ch∆∞a ƒë·∫øn gi·ªù
                  value:
                    error: File not yet available
                    availableFrom: "2025-11-20T10:00:00Z"
                    hoursUntilAvailable: 6

  /files/{shareToken}/totp/validate:
    post:
      tags:
        - Files
      summary: X√°c th·ª±c m√£ TOTP ƒë·ªÉ download file
      description: |
        G·ªçi endpoint n√†y tr∆∞·ªõc khi download file c√≥ TOTP enabled ƒë·ªÉ l·∫•y `downloadToken`.
        
        **Th·ª© t·ª± ki·ªÉm tra:**
        1. File status (expired/pending) ‚Üí 410/423
        2. File c√≥ TOTP enabled? ‚Üí 400 n·∫øu kh√¥ng
        3. M√£ TOTP ƒë√∫ng? ‚Üí 400 n·∫øu sai
        4. File c√≥ password? ‚Üí verify password trong request body ‚Üí 400 n·∫øu sai/thi·∫øu
        5. T·∫•t c·∫£ pass ‚Üí tr·∫£ `downloadToken` (valid 5 ph√∫t)
        
        **Lu·ªìng download file c√≥ TOTP:**
        1. Owner upload file v·ªõi `enableTOTP=true` ‚Üí nh·∫≠n secret + QR code ‚Üí qu√©t v√†o Google Authenticator
        2. User truy c·∫≠p `/files/{shareToken}` ƒë·ªÉ xem th√¥ng tin file
        3. N·∫øu `file.totpEnabled = true`, UI y√™u c·∫ßu nh·∫≠p m√£ TOTP (v√† password n·∫øu c√≥)
        4. User li√™n h·ªá owner (ƒëi·ªán tho·∫°i, chat, meeting,...) ƒë·ªÉ l·∫•y m√£ 6 s·ªë hi·ªán t·∫°i t·ª´ Google Authenticator
        5. User g·ªçi endpoint n√†y v·ªõi m√£ TOTP (v√† password n·∫øu file c√≥ password)
        6. Backend tr·∫£ v·ªÅ `downloadToken` t·∫°m th·ªùi (valid 5 ph√∫t)
        7. User g·ªçi `/files/{shareToken}/download?downloadToken=xxx` ƒë·ªÉ t·∫£i file
        
        **L∆∞u √Ω:** 
        - N·∫øu file c√≥ password, ph·∫£i g·ª≠i `password` trong request body c√πng v·ªõi m√£ TOTP
        - Kh√¥ng c·∫ßn Bearer token v√¨ ƒë√¢y l√† lu·ªìng download c√¥ng khai (ch·ªâ c·∫ßn TOTP t·ª´ owner)
      security: []
      parameters:
        - $ref: '#/components/parameters/ShareToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                code:
                  type: string
                  pattern: '^\d{6}$'
                  description: M√£ TOTP 6 ch·ªØ s·ªë do owner cung c·∫•p
                  example: "123456"
                password:
                  type: string
                  description: M·∫≠t kh·∫©u file (n·∫øu file c√≥ password)
                  example: "mypassword123"
              required:
                - code
      responses:
        '200':
          description: X√°c th·ª±c TOTP th√†nh c√¥ng
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: TOTP validated successfully
                  downloadToken:
                    type: string
                    description: Token t·∫°m th·ªùi ƒë·ªÉ download (valid 5 ph√∫t)
                    example: dt_a1b2c3d4e5f6g7h8
                  expiresIn:
                    type: integer
                    description: Th·ªùi gian h·∫øt h·∫°n token (gi√¢y)
                    example: 300
        '400':
          description: M√£ TOTP kh√¥ng h·ª£p l·ªá, sai password, ho·∫∑c file kh√¥ng c√≥ TOTP enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidTOTPCode:
                  summary: M√£ TOTP kh√¥ng ƒë√∫ng ho·∫∑c ƒë√£ h·∫øt h·∫°n
                  value:
                    error: Invalid TOTP code
                    message: The provided TOTP code is incorrect or expired. Please get the current code from the file owner
                wrongPassword:
                  summary: Sai password (n·∫øu file c√≥ password)
                  value:
                    error: Incorrect password
                    message: The file password is incorrect
                missingPassword:
                  summary: Thi·∫øu password (file c√≥ password)
                  value:
                    error: Password required
                    message: This file is password-protected. Please provide the password in the request body
                totpNotEnabled:
                  summary: File kh√¥ng c√≥ TOTP enabled
                  value:
                    error: TOTP not enabled
                    message: This file does not have TOTP protection enabled
        '404':
          description: Share token kh√¥ng t·ªìn t·∫°i
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                notFound:
                  summary: Token sai
                  value:
                    error: Not found
                    message: File not found
        '410':
          description: File ƒë√£ h·∫øt h·∫°n
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /admin/cleanup:
    post:
      tags:
        - Admin
      summary: X√≥a file h·∫øt h·∫°n
      description: |
        X√≥a file h·∫øt h·∫°n (Cron job ho·∫∑c Admin endpoint).
        Y√™u c·∫ßu X-Cron-Secret header ho·∫∑c admin token.
      security:
        - BearerAuth: []
        - CronSecret: []
      responses:
        '200':
          description: Cleanup ho√†n t·∫•t
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  deletedFiles:
                    type: integer
                  timestamp:
                    type: string
                    format: date-time
              examples:
                success:
                  summary: D·ªçn d·∫πp th√†nh c√¥ng
                  value:
                    message: Expired files removed
                    deletedFiles: 12
                    timestamp: "2025-11-19T10:00:00Z"
        '401':
          description: Thi·∫øu ho·∫∑c sai Bearer token / X-Cron-Secret
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingSecret:
                  summary: Thi·∫øu X-Cron-Secret
                  value:
                    error: Unauthorized
                    message: X-Cron-Secret header is required
                invalidToken:
                  summary: Token kh√¥ng h·ª£p l·ªá
                  value:
                    error: Unauthorized
                    message: Invalid or expired admin token
        '403':
          description: Kh√¥ng ph·∫£i admin ho·∫∑c secret sai
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                notAdmin:
                  summary: User kh√¥ng ph·∫£i admin
                  value:
                    error: Forbidden
                    message: You don't have permission to perform cleanup
                wrongSecret:
                  summary: X-Cron-Secret sai
                  value:
                    error: Forbidden
                    message: Invalid cron secret

  /admin/policy:
    get:
      tags:
        - Admin
      summary: L·∫•y c·∫•u h√¨nh h·ªá th·ªëng
      description: L·∫•y system policy (ch·ªâ admin)
      responses:
        '200':
          description: System policy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemPolicy'
              examples:
                success:
                  summary: Th√¥ng tin policy
                  value:
                    id: 1
                    maxFileSizeMB: 50
                    minValidityHours: 1
                    maxValidityDays: 30
                    defaultValidityDays: 7
                    requirePasswordMinLength: 6
        '401':
          description: Thi·∫øu ho·∫∑c sai Bearer token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingToken:
                  summary: Thi·∫øu Authorization header
                  value:
                    error: Unauthorized
                    message: Bearer token is required
        '403':
          description: Kh√¥ng ph·∫£i admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                notAdmin:
                  summary: User kh√¥ng c√≥ quy·ªÅn admin
                  value:
                    error: Forbidden
                    message: You don't have permission to access this resource

    patch:
      tags:
        - Admin
      summary: C·∫≠p nh·∫≠t c·∫•u h√¨nh h·ªá th·ªëng
      description: C·∫≠p nh·∫≠t system policy (ch·ªâ admin)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SystemPolicyUpdate'
      responses:
        '200':
          description: C·∫≠p nh·∫≠t th√†nh c√¥ng
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  policy:
                    $ref: '#/components/schemas/SystemPolicy'
              examples:
                success:
                  summary: Policy ƒë∆∞·ª£c c·∫≠p nh·∫≠t
                  value:
                    message: Policy updated
                    policy:
                      id: 1
                      maxFileSizeMB: 100
                      minValidityHours: 1
                      maxValidityDays: 14
                      defaultValidityDays: 5
                      requirePasswordMinLength: 8
        '400':
          description: Payload kh√¥ng h·ª£p l·ªá (gi√° tr·ªã < minimum)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidRange:
                  summary: maxValidityDays < minValidityHours
                  value:
                    error: Validation error
                    message: maxValidityDays must be greater than or equal to minValidityHours
        '401':
          description: Thi·∫øu ho·∫∑c sai Bearer token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingToken:
                  summary: Thi·∫øu Authorization header
                  value:
                    error: Unauthorized
                    message: Bearer token is required
        '403':
          description: Kh√¥ng ph·∫£i admin
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                notAdmin:
                  summary: User kh√¥ng c√≥ quy·ªÅn admin
                  value:
                    error: Forbidden
                    message: You don't have permission to access this resource

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token t·ª´ /auth/login

    CronSecret:
      type: apiKey
      in: header
      name: X-Cron-Secret
      description: Secret key cho cron job

  parameters:
    ShareToken:
      name: shareToken
      in: path
      required: true
      description: Share token c·ªßa file
      schema:
        type: string
        example: a1b2c3d4e5f6g7h8

  schemas:
    RegisterRequest:
      type: object
      required:
        - username
        - email
        - password
      properties:
        username:
          type: string
          description: T√™n ng∆∞·ªùi d√πng (unique)
          example: nam123
        email:
          type: string
          format: email
          description: Email (unique)
          example: nam@example.com
        password:
          type: string
          format: password
          minLength: 6
          description: M·∫≠t kh·∫©u (t·ªëi thi·ªÉu 6 k√Ω t·ª±)
          example: "123456"

    RegisterResponse:
      type: object
      properties:
        message:
          type: string
          example: User registered successfully
        userId:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: nam@example.com
        password:
          type: string
          format: password
          example: "123456"

    LoginResponse:
      type: object
      properties:
        accessToken:
          type: string
          example: eyJhbGciOi...
        user:
          $ref: '#/components/schemas/User'

    TOTPRequiredResponse:
      type: object
      properties:
        requireTOTP:
          type: boolean
          example: true
        message:
          type: string
          example: TOTP verification required

    TOTPVerifyRequest:
      type: object
      required:
        - email
        - code
      properties:
        email:
          type: string
          format: email
          example: nam@example.com
        code:
          type: string
          pattern: '^\d{6}$'
          example: "123456"

    TOTPSetupResponse:
      type: object
      properties:
        message:
          type: string
          example: TOTP secret generated
        totpSetup:
          type: object
          properties:
            secret:
              type: string
              example: NB2W45DFOIZA====
            qrCode:
              type: string
              example: data:image/png;base64,...

    FileUploadRequest:
      type: object
      required:
        - file
      properties:
        file:
          type: string
          format: binary
          description: File c·∫ßn upload
        isPublic:
          type: boolean
          default: true
          description: File public hay private
        password:
          type: string
          minLength: 6
          description: M·∫≠t kh·∫©u b·∫£o v·ªá (min 6 k√Ω t·ª±)
        availableFrom:
          type: string
          format: date-time
          description: Th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu hi·ªáu l·ª±c
          example: "2025-11-10T00:00:00Z"
        availableTo:
          type: string
          format: date-time
          description: Th·ªùi ƒëi·ªÉm k·∫øt th√∫c hi·ªáu l·ª±c
          example: "2025-11-17T00:00:00Z"
        sharedWith:
          type: array
          items:
            type: string
            format: email
          description: Danh s√°ch email ƒë∆∞·ª£c ph√©p t·∫£i
          example: ["user1@example.com", "user2@example.com"]
        enableTOTP:
          type: boolean
          default: false
          description: |
            B·∫≠t TOTP cho file. N·∫øu true, backend s·∫Ω sinh secret + QR code trong response.
            Owner qu√©t QR v√†o Google Authenticator ƒë·ªÉ l·∫•y m√£ TOTP cung c·∫•p cho ng∆∞·ªùi download.

    FileUploadResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        file:
          $ref: '#/components/schemas/File'
        totpSetup:
          type: object
          description: Ch·ªâ c√≥ khi upload v·ªõi enableTOTP=true
          properties:
            secret:
              type: string
              description: TOTP secret ƒë·ªÉ add v√†o Google Authenticator
              example: NB2W45DFOIZA====
            qrCode:
              type: string
              description: QR code d·∫°ng base64 ƒë·ªÉ qu√©t
              example: data:image/png;base64,iVBORw0KGgo...
        message:
          type: string
          example: File uploaded successfully

    File:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        fileName:
          type: string
          example: document.pdf
        fileSize:
          type: integer
          description: K√≠ch th∆∞·ªõc file (bytes)
          example: 2048576
        mimeType:
          type: string
          example: application/pdf
        shareToken:
          type: string
          example: a1b2c3d4e5f6g7h8
        shareLink:
          type: string
          format: uri
          example: https://example.com/f/a1b2c3d4e5f6g7h8
        isPublic:
          type: boolean
          example: false
        hasPassword:
          type: boolean
          example: true
        availableFrom:
          type: string
          format: date-time
          example: "2025-11-10T00:00:00Z"
        availableTo:
          type: string
          format: date-time
          example: "2025-11-17T00:00:00Z"
        validityDays:
          type: integer
          example: 7
        status:
          type: string
          enum: [pending, active, expired]
          description: |
            - pending: Ch∆∞a ƒë·∫øn availableFrom
            - active: Trong th·ªùi gian hi·ªáu l·ª±c
            - expired: ƒê√£ h·∫øt h·∫°n
          example: active
        hoursRemaining:
          type: number
          description: S·ªë gi·ªù c√≤n l·∫°i ƒë·∫øn h·∫øt h·∫°n
          example: 120.5
        sharedWith:
          type: array
          items:
            type: string
            format: email
          example: ["user1@example.com", "user2@example.com"]
        totpEnabled:
          type: boolean
          description: File c√≥ b·∫≠t TOTP hay kh√¥ng (ƒë∆∞·ª£c set khi upload v·ªõi enableTOTP=true)
          example: false
        owner:
          $ref: '#/components/schemas/User'
        createdAt:
          type: string
          format: date-time
          example: "2025-11-04T12:00:00Z"

    FileInfoResponse:
      type: object
      properties:
        file:
          $ref: '#/components/schemas/File'

    UserProfileResponse:
      type: object
      description: Response cho GET /user - bao g·ªìm th√¥ng tin user v√† danh s√°ch file
      properties:
        user:
          $ref: '#/components/schemas/User'
        files:
          type: array
          items:
            $ref: '#/components/schemas/File'
          description: Danh s√°ch file c·ªßa user (c√≥ th·ªÉ filter theo status)
        pagination:
          type: object
          properties:
            currentPage:
              type: integer
              example: 1
            totalPages:
              type: integer
              example: 3
            totalFiles:
              type: integer
              example: 42
            limit:
              type: integer
              example: 20
        summary:
          type: object
          properties:
            activeFiles:
              type: integer
              description: S·ªë file ƒëang active
              example: 28
            pendingFiles:
              type: integer
              description: S·ªë file ch∆∞a ƒë·∫øn th·ªùi gian hi·ªáu l·ª±c
              example: 5
            expiredFiles:
              type: integer
              description: S·ªë file ƒë√£ h·∫øt h·∫°n
              example: 9
            deletedFiles:
              type: integer
              description: S·ªë file ƒë√£ b·ªã x√≥a
              example: 0

    SystemPolicy:
      type: object
      properties:
        id:
          type: integer
          example: 1
        maxFileSizeMB:
          type: integer
          example: 50
        minValidityHours:
          type: integer
          example: 1
        maxValidityDays:
          type: integer
          example: 30
        defaultValidityDays:
          type: integer
          example: 7
        requirePasswordMinLength:
          type: integer
          example: 6

    SystemPolicyUpdate:
      type: object
      properties:
        maxFileSizeMB:
          type: integer
          minimum: 1
          example: 100
        minValidityHours:
          type: integer
          minimum: 1
          example: 1
        maxValidityDays:
          type: integer
          minimum: 1
          example: 14
        defaultValidityDays:
          type: integer
          minimum: 1
          example: 5
        requirePasswordMinLength:
          type: integer
          minimum: 4
          example: 8

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        username:
          type: string
          example: nam123
        email:
          type: string
          format: email
          example: nam@example.com
        role:
          type: string
          enum: [user, admin]
          example: user
        totpEnabled:
          type: boolean
          example: true

    Error:
      type: object
      properties:
        error:
          type: string
          example: Error message
        message:
          type: string
          example: Detailed error description
        code:
          type: string
          example: VALIDATION_ERROR

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Validation error
            message: Invalid input data

    Unauthorized:
      description: Unauthorized - Missing or invalid token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Unauthorized
            message: Invalid or missing authentication token

    Forbidden:
      description: Forbidden - Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Forbidden
            message: You don't have permission to access this resource

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Not found
            message: The requested resource was not found
